---
title: "Market-Index-Portfolio through PCA and K-Means"
author: "Edgar Sigfrido Soto Aparicio"
date: "2023-06-28"
output: html_document
---

# Librerias
```{r}
library(tidyverse)
library(readxl)
library(textshape) #"Tools for Reshaping Text". Usado en columns_to_rownames
library(broom)
library(plotly)
library(scales)
library(caTools)
library(caret)
library(cluster)
library(factoextra) #Para graficar K-Means y PCA
library(psych) #Usado por su funsi칩n de crar matices de correlaciones de colores
library(stats) #Para hacer el PCA
library(naniar) #Para limpiar las bases de datos
library(fBasics) #Analisis estadistico
library(PerformanceAnalytics)
library(statmod)
library(knitr)
library(stargazer)
library(kableExtra)
library(ggpubr)
library(ggdist)
library(ggExtra)
library(ggbeeswarm)
library(aTSA) #Raiz Unitaria
library(tseries) #Raiz Unitaria
library(QuantPsyc) #Pruba multivariada
library(ghyp) #Para hacer momentos estadisticos de la NIG
library(quantmod) #Para descargar datos
library(cramer) #Para la prueba de cramer 
library(PortfolioAnalytics)
library(DEoptim)
library(tidyquant)
library(NbClust)
library(dendextend)
library(xts)
library(zoo)
```

# Creaci칩n de las Data Frames
```{r}
df <- read_excel("APLHA/ALPHA_1/ALPHA_1.1/1.1.1PCA_Codes/Criterios-Unificado (Datos para PCA).xlsx")
df <- df[,-6]
df_plot <- df #Data Frame para hacer gr치ficas descriptivas
df <- column_to_rownames(df, loc = 1)

df_plot <- cbind(df_plot[,-5], log10(df$GDP))
colnames(df_plot)[5] = "GDP"

df <- column_to_rownames(df_plot, 
                         loc = 1)
```

# Graficas descriptivas de las variables
```{r}
df_plot %>%
  ggplot(aes(x=GDP))+
  geom_histogram(bins=100)+
  geom_label(data = df_plot %>%
               filter(GDP>13), aes(x=GDP,y=Country, 
                                        label=Country))
```

# PCA
```{r}
pca_df <- prcomp(df, 
                 center = TRUE, 
                 scale. = TRUE)
summary(pca_df)

#biplot(pca_df)

fviz_pca_biplot(pca_df)
fviz_contrib(pca_df, 
             choice = "var")
fviz_contrib(pca_df, 
             choice = "ind")
fviz_screeplot(pca_df)

df_PC1234 <- cbind(df, 
                   as.data.frame(pca_df$x)) %>% 
  arrange(desc(PC1))
View(df_PC1234)

df_PC12 <- as.data.frame(pca_df$x)
df_PC12 <- df_PC12[,1:2]
View(df_PC12)
```

# Kmeans sobre el PCA
## Primer kmeans sobre PC12
```{r}
NbClust(df_PC12,
        distance = "euclidean",
        method = "kmeans")

kmean1_df_PC12 <- kmeans(df_PC12, 
                           centers = 3,
                           iter.max = 50) #creamos objeto de kmeans con la df principal

fviz_cluster(kmean1_df_PC12, 
             data = df_PC12)
```

## Segundo kmeans sobre PC12
```{r}
df_K1C1 <- cbind(df_PC12, 
                 as.data.frame(kmean1_df_PC12$cluster))
colnames(df_K1C1)[3] = "K1C1"
df_K1C1 <- df_K1C1 %>%
  filter(K1C1==3)
df_K1C1 <- df_K1C1[,-3]
View(df_K1C1)
#----
NbClust(df_K1C1,
        distance = "euclidean",
        method = "kmeans")

kmean2_df_PC12 <- kmeans(df_K1C1, 
                         centers = 2,
                         iter.max = 50)

fviz_cluster(kmean2_df_PC12, 
             data = df_K1C1)

```

## Tercer kmeans sobre PC12
```{r}
df_K2C2 <- cbind(df_K1C1,
                 as.data.frame(kmean2_df_PC12$cluster))
colnames(df_K2C2)[3] = "K2C2"
df_K2C2 <- df_K2C2 %>%
  filter(K2C2==2)
df_K2C2 <- df_K2C2[,-3]
View(df_K2C2)
#----
kmean3_df_PC12 <- kmeans(df_K2C2, 
                         centers = 2,
                         iter.max = 50)

fviz_cluster(kmean3_df_PC12, 
             data = df_K2C2)

df_K3C2 <- cbind(df_K2C2,
                 as.data.frame(kmean3_df_PC12$cluster))
colnames(df_K3C2)[3] = "K3C2"
df_K3C2 <- df_K3C2 %>%
  filter(K3C2==2)
df_K3C2 <- df_K3C2[,-3]
View(df_K3C2)

df_K3C1 <- cbind(df_K2C2,
                 as.data.frame(kmean3_df_PC12$cluster))
colnames(df_K3C1)[3] = "K3C1"
df_K3C1 <- df_K3C1 %>%
  filter(K3C1==1)
df_K3C1 <- df_K3C1[,-3]
View(df_K3C1)
```

intento de chat gpt. borrar mas tarde
```{r}
calculate_column_means <- function(matrix_data) {
  column_means <- colMeans(matrix_data)
  return(column_means)
}
calculate_column_means(k3c2_matrix)

#---

create_base_norm_data <- function(matrix_data) {
  col_names <- colnames(matrix_data)
  
  column_pdf <- apply(matrix_data, 2, function(col) dnorm(col, mean(col), 
                                                          sd(col), 
                                                          length(col)))
  
  base_norm_df <- data.frame(t(column_pdf))
  colnames(base_norm_df) <- col_names
  rownames(base_norm_df) <- "base.norm"
  return(base_norm_df)
}
create_base_norm_data(indices)



column_pdf <- apply(matrix_data, 2, function(col) dnorm(col, mean(col), sd(col), length(col)))
```


# Indices (indices ser치 el benchmark)
```{r}
# Indices de capital de los paises, bajados de Bloomberg
indices <- read_excel("Indices_km.xlsx", 
                      sheet = "Hoja1",
                      col_types = c("date", 
                                    "numeric", "numeric", "numeric", "numeric", "numeric", 
                                    "numeric", "numeric", "numeric", "numeric", "numeric", 
                                    "numeric", "numeric", "numeric", "numeric", "numeric", 
                                    "numeric", "numeric", "numeric", "numeric"))
names(indices)[names(indices) == '...1'] <- 'Date'
indices <- indices[-1,]
indices <- na.omit(indices)
indices <- column_to_rownames(indices, loc = 1)
indices <- round(indices, digits = 2)
indices <- as.xts(indices)
new_names <- c("United States", "Australia", "India", "Italy", "Mexico", 
               "Russian Federation", "Saudi Arabia", "Spain", "Canada", "China",
               "France", "Germany","Japan", "Korea, Rep", "Netherlands", 
               "Switzerland", "United Kingdom", "Brazil", "South Africa")
colnames(indices) <- new_names
View(indices)
class(indices)

indices <- indices
indices_scale <- scale(indices)
plot(indices_scale)
```

## Time frames (para el benchmark)
```{r}
# pre pandemia
to_pre.crisis.to.pre.pandemic <- as.POSIXct("2020-02-27")
indices_pre.crisis.to.pre.pandemic <- indices[index(indices) <= to_pre.crisis.to.pre.pandemic]
indices_pre.crisis.to.pre.pandemic_scale <- scale(indices_pre.crisis.to.pre.pandemic)
# pre crisis financiera
to_pre.crisis <- as.POSIXct("2007-06-30")
indices_pre.crisis <- indices[index(indices) <= to_pre.crisis]
indices_pre.crisis_scale <- scale(indices_pre.crisis)
# entre crisis y crisis
from_pos.crisis <- as.POSIXct("2011-06-30")
to_pre.pandemic <- as.POSIXct("2020-02-27")
indices_pos.crisis_pre.pandemic <- indices[index(indices) >= from_pos.crisis & index(indices) <= to_pre.pandemic]
indices_pos.crisis_pre.pandemic_scale <- scale(indices_pos.crisis_pre.pandemic)
# pandemic
from_pandemic <- as.POSIXct("2020-02-27")
to_pandemic <- as.POSIXct("2023-04-09")
indices_pandemic <- indices[index(indices) >= from_pandemic & index(indices) <= to_pandemic]
indices_pandemic_scale <- scale(indices_pandemic)
# pos pandemic
from_pos.pandemic <- as.POSIXct("2023-04-10")
indices_pos.pandemic <- indices[index(indices) >= from_pos.pandemic]
indices_pos.pandemic_scale <- scale(indices_pos.pandemic)
```

## Portafolios de los grupos de K-Means y BRICS

### K3C1 time frames
```{r}
k3c1 <- c("Canada", "China", "France", "Germany", 
          "Japan", "Korea, Rep", "Netherlands", "Switzerland",
          "United Kingdom", "United States")
# Generral Time Frame
k3c1_matrix <- indices[,c("Canada", "China", "France", "Germany", 
                          "Japan", "Korea, Rep", "Netherlands", "Switzerland",
                          "United Kingdom", "United States")]

# k3c1 pre crisis
k3c1_matrix_pre.crisis <- indices_pre.crisis[,c("Canada", "China", "France", "Germany", "Japan", "Korea, Rep", "Netherlands", "Switzerland", "United Kingdom", "United States")]

# k3c1 between crisis and crisis
k3c1_matrix_pos.crisis_pre.pandemic <- indices_pos.crisis_pre.pandemic[,c("Canada", "China", "France", "Germany", "Japan", "Korea, Rep", "Netherlands", "Switzerland", "United Kingdom", "United States")]

# pandemic
k3c1_matrix_pandemic <- indices_pandemic[,c("Canada", "China", "France", "Germany", "Japan", "Korea, Rep", "Netherlands", "Switzerland", "United Kingdom", "United States")]

# pos pandemic
k3c1_matrix_pos.pandemic <- indices_pos.pandemic[,c("Canada", "China", "France", "Germany", "Japan", "Korea, Rep", "Netherlands", "Switzerland", "United Kingdom", "United States")]
```

### K3C2 time frames
```{r}
k3c2 <- c("Australia", "India", "Italy", "Mexico", "Russian Federation", 
          "Saudi Arabia", "Spain")
# General
k3c2_matrix <- indices[,c("Australia", "India", "Italy", "Mexico", 
                          "Russian Federation", "Saudi Arabia", "Spain")]
k3c2_matrix_scale <- scale(k3c2_matrix)

# k3c2 pre crisis
k3c2_matrix_pre.crisis <- indices_pre.crisis[,c("Australia", "India", "Italy", "Mexico", "Russian Federation", "Saudi Arabia", "Spain")]

# k3c2 between crisis and crisis
k3c2_matrix_pos.crisis_pre.pandemic <- indices_pos.crisis_pre.pandemic[,c("Australia", "India", "Italy", "Mexico", 
                          "Russian Federation", "Saudi Arabia", "Spain")]

# k3c2 pandemic
k3c2_matrix_pandemic <- indices_pandemic[,c("Australia", "India", "Italy", "Mexico", "Russian Federation", "Saudi Arabia", "Spain")]

# k3c2 pos pandemic
k3c2_matrix_pos.pandemic <- indices_pos.pandemic[,c("Australia", "India", "Italy", "Mexico", "Russian Federation", "Saudi Arabia", "Spain")]
```

### BRICS
```{r}
brics <- c("Brazil", "Russian Federation", "India", "China", "South Africa")
# General
brics_matrix <- indices[,c("Brazil", "Russian Federation", "India", 
                           "China", "South Africa")]
brics_matrix_scale <- scale(brics_matrix)
# BRICS pre crisis
indices_pre.crisis

# BRICS between crisis and crisis
indices_pos.crisis_pre.pandemic

# BRICS pandemic
indices_pandemic

# BRICS pos pandemic
indices_pos.pandemic
```


# Pruebas estadisticas

## Basic Stats
```{r}
basic.stat.indices <- basicStats(indices)
basic.stats.k3c1 <- basicStats(k3c1_matrix)
basic.stats.k3c2 <- basicStats(k3c2_matrix)
basic.stats.brics <- basicStats(brics_matrix)
```

## adf.test for Stationarity
```{r}
adf.apply <- apply(indices,
                   MARGIN = 2,
                   FUN = adf.test)
adf.table <- read_excel("adf.table.xlsx", sheet = "Sheet2")
names(adf.table)[names(adf.table) == '...1'] <- 'Country'

adf.table <- adf.table %>%
  arrange(desc(`p-value`))

adf.table %>%
  ggplot(aes(x=Country, y=`p-value`))+
  geom_col()

```

## ks.test univariadas normal y nig
```{r}
ks.univariate.test.function <- function(serie, cdf){
  vector.series <- as.vector(serie)
  ks.test(vector.series, cdf)
}

ks.univ.norm_indices <- apply(indices,
                              MARGIN = 2,
                              FUN = ks.univariate.test.function, 
                              cdf = "pnorm")

ks.univ.nig_indices <- apply(indices,
                             MARGIN = 2,
                             FUN = ks.univariate.test.function, 
                             cdf = "pnig")
```

------
Creacion de las bases para la prueba K-S univariada normal
Esta ahora es opcional, ya que hay una mejor forma
```{r}
m_United.States <- mean(indices$`United States`)
sd_United.States <- sd(indices$`United States`)
len_United.States <- length(indices$`United States`)
base.normal_United.States <- dnorm(len_United.States,
                                   m_United.States,
                                   sd_United.States)

m_Australia <- mean(indices$Australia)
sd_Australia <- sd(indices$Australia)
len_Australia <- length(indices$Australia)
base.normal_Australia <- dnorm(len_Australia,
                               m_Australia,
                               sd_Australia)

m_India <- mean(indices$India)
sd_India <- sd(indices$India)
len_India <- length(indices$India)
base.normal_India <- dnorm(len_India,
                               m_India,
                               sd_India)

m_Italy <- mean(indices$Italy)
sd_Italy <- sd(indices$Italy)
len_Italy <- length(indices$Italy)
base.normal_Italy <- dnorm(len_Italy,
                           m_Italy,
                           sd_Italy)

m_Mexico <- mean(indices$Mexico)
sd_Mexico <- sd(indices$Mexico)
len_Mexico <- length(indices$Mexico)
base.normal_Mexico <- dnorm(len_Mexico,
                           m_Mexico,
                           sd_Mexico)

m_Russian.Federation <- mean(indices$`Russian Federation`)
sd_Russian.Federation <- sd(indices$`Russian Federation`)
len_Russian.Federation <- length(indices$`Russian Federation`)
base.normal_Russian.Federation <- dnorm(len_Russian.Federation,
                            m_Russian.Federation,
                            sd_Russian.Federation)

m_Saudi.Arabia <- mean(indices$`Saudi Arabia`)
sd_Saudi.Arabia <- sd(indices$`Saudi Arabia`)
len_Saudi.Arabia <- length(indices$`Saudi Arabia`)
base.normal_Saudi.Arabia <- dnorm(len_Saudi.Arabia,
                                        m_Saudi.Arabia,
                                        sd_Saudi.Arabia)

m_Spain <- mean(indices$Spain)
sd_Spain <- sd(indices$Spain)
len_Spain <- length(indices$Spain)
base.normal_Spain <- dnorm(len_Spain,
                           m_Spain,
                           sd_Spain)

m_Canada <- mean(indices$Canada)
sd_Canada <- sd(indices$Canada)
len_Canada <- length(indices$Canada)
base.normal_Canada <- dnorm(len_Canada,
                           m_Canada,
                           sd_Canada)

m_China <- mean(indices$China)
sd_China <- sd(indices$China)
len_China <- length(indices$China)
base.normal_China <- dnorm(len_China,
                            m_China,
                            sd_China)

m_France <- mean(indices$France)
sd_France <- sd(indices$France)
len_France <- length(indices$France)
base.normal_France <- dnorm(len_France,
                           m_France,
                           sd_France)

m_Germany <- mean(indices$Germany)
sd_Germany <- sd(indices$Germany)
len_Germany <- length(indices$Germany)
base.normal_Germany <- dnorm(len_Germany,
                            m_Germany,
                            sd_Germany)

m_Japan <- mean(indices$Japan)
sd_Japan <- sd(indices$Japan)
len_Japan <- length(indices$Japan)
base.normal_Japan <- dnorm(len_Japan,
                             m_Japan,
                             sd_Japan)

m_Korea.Rep <- mean(indices$`Korea, Rep`)
sd_Korea.Rep <- sd(indices$`Korea, Rep`)
len_Korea.Rep <- length(indices$`Korea, Rep`)
base.normal_Korea.Rep <- dnorm(len_Korea.Rep,
                           m_Korea.Rep,
                           sd_Korea.Rep)

m_Netherlands <- mean(indices$Netherlands)
sd_Netherlands <- sd(indices$Netherlands)
len_Netherlands <- length(indices$Netherlands)
base.normal_Netherlands <- dnorm(len_Netherlands,
                               m_Netherlands,
                               sd_Netherlands)

m_Switzerland <- mean(indices$Switzerland)
sd_Switzerland <- sd(indices$Switzerland)
len_Switzerland <- length(indices$Switzerland)
base.normal_Switzerland <- dnorm(len_Switzerland,
                                 m_Switzerland,
                                 sd_Switzerland)

m_United.Kingdom <- mean(indices$`United Kingdom`)
sd_United.Kingdom <- sd(indices$`United Kingdom`)
len_United.Kingdom <- length(indices$`United Kingdom`)
base.normal_United.Kingdom <- dnorm(len_United.Kingdom,
                                 m_United.Kingdom,
                                 sd_United.Kingdom)

m_Brazil <- mean(indices$Brazil)
sd_Brazil <- sd(indices$Brazil)
len_Brazil <- length(indices$Brazil)
base.normal_Brazil <- dnorm(len_Brazil,
                            m_Brazil,
                            sd_Brazil)

m_South.Africa <- mean(indices$`South Africa`)
sd_South.Africa <- sd(indices$`South Africa`)
len_South.Africa <- length(indices$`South Africa`)
base.normal_South.Africa <- dnorm(len_South.Africa,
                            m_South.Africa,
                            sd_South.Africa)
```

Pruebas de K-S univariadas normlaes
```{r}
ks_United.States <- ks.test(as.vector(indices$`United States`),
                            base.normal_United.States)
ks_United.States <- as.data.frame(ks_United.States[["p.value"]])

ks_Australia <- ks.test(as.vector(indices$Australia),
                        base.normal_Australia)
ks_Australia <- as.data.frame(ks_Australia[["p.value"]])

ks_India <- ks.test(as.vector(indices$India),
                    base.normal_India)
ks_India <- as.data.frame(ks_India[["p.value"]])

ks_Italy <- ks.test(as.vector(indices$Italy),
                    base.normal_Italy)
ks_Italy <- as.data.frame(ks_Italy[["p.value"]])

ks_Mexico <- ks.test(as.vector(indices$Mexico),
                     base.normal_Mexico)
ks_Mexico <- as.data.frame(ks_Mexico[["p.value"]])

ks_Russian.Federation <- ks.test(as.vector(indices$`Russian Federation`),
                                 base.normal_Russian.Federation)
ks_Russian.Federation <- as.data.frame(ks_Russian.Federation[["p.value"]])

ks_Saudi.Arabia <- ks.test(as.vector(indices$`Saudi Arabia`),
                           base.normal_Saudi.Arabia)
ks_Saudi.Arabia <- as.data.frame(ks_Saudi.Arabia[["p.value"]])

ks_Spain <- ks.test(as.vector(indices$Spain),
                    base.normal_Spain)
ks_Spain <- as.data.frame(ks_Spain[["p.value"]])

ks_Canada <- ks.test(as.vector(indices$Canada),
                     base.normal_Canada)
ks_Canada <- as.data.frame(ks_Canada[["p.value"]])

ks_China <- ks.test(as.vector(indices$China),
                    base.normal_China)
ks_China <- as.data.frame(ks_China[["p.value"]])

ks_France <- ks.test(as.vector(indices$France),
                     base.normal_France)
ks_France <- as.data.frame(ks_France[["p.value"]])

ks_Germany <- ks.test(as.vector(indices$Germany),
                      base.normal_Germany)
ks_Germany <- as.data.frame(ks_Germany[["p.value"]])

ks_Japan <- ks.test(as.vector(indices$Japan),
                    base.normal_Japan)
ks_Japan <- as.data.frame(ks_Japan[["p.value"]])

ks_Korea.Rep <- ks.test(as.vector(indices$`Korea, Rep`),
                    base.normal_Korea.Rep)
ks_Korea.Rep <- as.data.frame(ks_Korea.Rep[["p.value"]])

ks_Netherlands <- ks.test(as.vector(indices$Netherlands),
                          base.normal_Netherlands)
ks_Netherlands <- as.data.frame(ks_Netherlands[["p.value"]])

ks_Switzerland <- ks.test(as.vector(indices$Switzerland),
                          base.normal_Switzerland)
ks_Switzerland <- as.data.frame(ks_Switzerland[["p.value"]])

ks_United.Kingdom <- ks.test(as.vector(indices$`United Kingdom`),
                             base.normal_United.Kingdom)
ks_United.Kingdom <- as.data.frame(ks_Brazil[["p.value"]])

ks_Brazil <- ks.test(as.vector(indices$Brazil),
                     base.normal_Brazil)
ks_Brazil <- as.data.frame(ks_Brazil[["p.value"]])

ks_South.Africa <- ks.test(as.vector(indices$`South Africa`),
                     base.normal_South.Africa)
ks_South.Africa <- as.data.frame(ks_South.Africa[["p.value"]])
```
-------


```{r}
#Parametros de la NIG
NIG_United.States <- nigFit(indices$`United States`)

#Agrupar parametros en un objeto
a <- NIG_United.States@fit[["par"]]
a <- data.frame(t(a))
   
#NIG aleatoria con parametors univariados de nuestra serie
r <- rnig(len_United.States,
          alpha = a$alpha, 
          beta = a$beta,
          delta = a$delta,
          mu = a$mu)

plot(density(r),
     col="black",
     main="NIG Univariada",
     sub="SP index")
   
#Pruba de Kormogorov univariada para NIG
ks.test(as.vector(indices$`United States`), "pnorm")

```

# Portfolios Normal Distribution

## Benchmark
```{r echo=FALSE include = FALSE}
Specs_Port_Norm_indices <- portfolio.spec(indices)

##### Add Constraints #####
Specs_Port_Norm_indices <- add.constraint(Specs_Port_Norm_indices,
                                          type = "full_investment")
Specs_Port_Norm_indices <- add.constraint(Specs_Port_Norm_indices,
                                          type = "long_only")

##### Add Objective #####
Specs_Port_Norm_indices <- add.objective(Specs_Port_Norm_indices,
                                         type = "risk",
                                         name = "StdDev")
Specs_Port_Norm_indices <- add.objective(Specs_Port_Norm_indices,
                                         type = 'return',
                                         name = 'mean')
Specs_Port_Norm_indices

##### Optimization #####
Optimized_Port_Norm_indices <- optimize.portfolio(indices,
                                                  Specs_Port_Norm_indices,
                                                  trace = TRUE)

chart.Weights(Optimized_Port_Norm_indices, 
              plot.type = "barplot")
Weights_Optimized_Port_Norm_indices <- extractWeights(Optimized_Port_Norm_indices)
sum(Weights_Optimized_Port_Norm_indices)
```







Portfolio analysis Normal Distribution
```{r}
Return_opt_NORM <- Return.portfolio(Portafolio_NORM,
                                    W_R_NORM)

table.AnnualizedReturns(Return_opt_NORM,
                        scale = 252,
                        geometric = FALSE)

Return.cumulative(Return_opt_NORM,
                  geometric = FALSE)

chart.RiskReward(Optimized_Port_NORM,
                 risk.col = 'StdDev',
                 return.col = 'mean',
                 chart.assets = T)
```




